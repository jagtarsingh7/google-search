<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>not-google ‚ù§Ô∏è</title>
  <style>
    :root { --blue:#1a73e8; --shadow:0 8px 28px rgba(0,0,0,.15); }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:grid; place-items:center; background:#fff; color:#202124;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    }
    .wrap{width:min(720px,92vw); text-align:center;}
    .logo{font-size:clamp(42px,8vw,86px); font-weight:800; letter-spacing:.5px; user-select:none}
    .logo span:nth-child(1){color:#4285F4}
    .logo span:nth-child(2){color:#DB4437}
    .logo span:nth-child(3){color:#F4B400}
    .logo span:nth-child(4){color:#4285F4}
    .logo span:nth-child(5){color:#0F9D58}
    .logo span:nth-child(6){color:#DB4437}

    .search{ margin:22px auto 0; display:flex; align-items:center; gap:10px; padding:12px 16px;
      border:1px solid #dadce0; border-radius:999px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.06);
      transition:box-shadow .15s ease, transform .15s ease; }
    .search:focus-within{ box-shadow:0 10px 24px rgba(0,0,0,.12); transform:translateY(-1px); }
    .search input{flex:1; border:0; outline:none; font-size:16px; padding:6px 4px}
    .btns{display:flex; justify-content:center; gap:10px; margin-top:24px; flex-wrap:wrap}
    button{ border:1px solid #f1f3f4; background:#f8f9fa; padding:10px 18px; border-radius:8px; cursor:pointer; font-size:14px;
      transition:transform .02s ease, background .15s ease, border-color .15s ease; }
    button:hover{background:#f1f3f4; border-color:#dadce0}
    button:active{transform:translateY(1px)}
    .hint{margin-top:10px; font-size:12px; color:#5f6368}

    /* Modal */
    dialog{ border:none; padding:0; border-radius:16px; box-shadow:var(--shadow); width:min(560px,92vw); overflow:hidden; }
    .modal{ display:flex; flex-direction:column; height:min(70vh, 640px); }
    .modal-header{ padding:16px 18px; border-bottom:1px solid #eceff1; display:flex; align-items:center; justify-content:space-between; }
    .modal-header h1{ margin:0; font-size:18px; font-weight:700; display:flex; align-items:center; gap:8px }
    .modal-header .heart{ animation:beat 1.2s infinite }
    @keyframes beat{0%,100%{transform:scale(1)} 50%{transform:scale(1.12)}}

    .chat{ flex:1; overflow:auto; padding:14px 14px 8px; background:#fbfcff }
    .msg{ max-width:80%; margin:8px 0; padding:10px 12px; border-radius:14px; font-size:14px; line-height:1.35; box-shadow:0 1px 2px rgba(0,0,0,.06); }
    .me{ margin-left:auto; background:#e8f0fe; border:1px solid #d2e3fc; }
    .bot{ margin-right:auto; background:#fff; border:1px solid #e5e7eb; }
    .thinking{ color:#9aa0a6; font-style:italic }

    .composer{ display:flex; gap:8px; padding:12px; border-top:1px solid #eceff1; background:#fff }
    .composer input{ flex:1; padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px; outline:none; font-size:14px }
    .composer button{ border:1px solid #e5e7eb; background:#f8f9fa; border-radius:10px; padding:10px 14px; }

    /* Confetti */
    .confetti{position:fixed; inset:0; pointer-events:none}
    .confetti i{position:absolute; width:8px; height:14px; opacity:0; transform:translateY(-20px) rotate(0deg)}
  </style>
</head>
<body>
  <main class="wrap">
    <div class="logo" aria-label="Logo">
      <span>G</span><span>o</span><span>o</span><span>g</span><span>l</span><span>e</span>
    </div>

    <form id="searchForm" autocomplete="off" role="search" aria-label="Search demo">
      <div class="search">
        <input id="q" type="text" placeholder="Search..." aria-label="Search input"/>
      </div>
      <div class="btns">
        <button type="submit">Google Search</button>
        <button type="button" id="lucky">I'm Feeling Lucky</button>
      </div>
      <div class="hint">Type anything. We‚Äôll open a playful chat that nudges you toward YES üíò</div>
      <div class="hint" id="statusLine" aria-live="polite"></div>
      <div style="margin-top:8px">
        <button type="button" id="testWrite" style="font-size:12px;border:1px solid #e5e7eb;padding:6px 10px;border-radius:6px;background:#fff;cursor:pointer">Run Firestore test write</button>
      </div>
    </form>
  </main>

  <dialog id="resultDialog">
    <div class="modal">
      <div class="modal-header">
        <h1>not-google chat <span class="heart">üíô</span></h1>
        <button id="closeModal" title="Close" style="border:0;background:transparent;font-size:18px;cursor:pointer">‚úñ</button>
      </div>
      <div id="chat" class="chat" aria-live="polite"></div>
      <div class="composer">
        <input id="chatInput" type="text" placeholder="Type a reply‚Ä¶"/>
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </dialog>
  <div class="confetti" id="confetti"></div>

  <!-- Firebase: log initial search + chat turns to Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, doc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBmR-D0xa8c_wh2vS7uPw1FwL_7-fN8Xjo",
      authDomain: "hope-6fe19.firebaseapp.com",
      projectId: "hope-6fe19",
      storageBucket: "hope-6fe19.firebasestorage.app",
      messagingSenderId: "605032966039",
      appId: "1:605032966039:web:122b19f529e5db9ee7c6d2",
      measurementId: "G-S8G7B4EY5T"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    signInAnonymously(auth)
      .then(()=>console.log('‚úÖ Firebase: Signed in anonymously.'))
      .catch(err=>console.error('‚ùå Firebase Auth Error:', err));
    onAuthStateChanged(auth,u=>{ if(u) console.log('üë§ Firebase UID:', u.uid); });

    // Simple session id for this page load
    function uuid(){ if (crypto?.randomUUID) return crypto.randomUUID(); return 'xxxxxxx'.replace(/x/g,()=>Math.random().toString(16).slice(2,3)); }
    const sessionId = uuid();

    // Firestore helpers
    async function logSessionStart(initialQuery){
      try{
        const ref = await addDoc(collection(db, 'sessions'), {
          sessionId,
          initialQuery,
          ua: navigator.userAgent || '',
          createdAt: serverTimestamp()
        });
        console.log('‚úÖ Firestore: session started id=', ref.id);
        return ref.id;
      }catch(e){ console.error('‚ùå Firestore session start failed:', e); return null; }
    }

    async function logMessage(sessionDocId, role, text){
      try{
        const ref = await addDoc(collection(db, 'sessions', sessionDocId, 'messages'), {
          role, text, ts: serverTimestamp()
        });
        console.log(`‚úÖ Firestore: logged ${role} message`, ref.id);
      }catch(e){ console.error('‚ùå Firestore message log failed:', e); }
    }

    // Expose to window for the non-module script
    window.__db = { logSessionStart, logMessage };
  </script>

  <script>
    // Pools
    const POOLS = {
      romantic: [
        "Plot twist: your heart already decided. It whispered ‚Äòyes‚Äô.",
        "If smiles were votes, ‚Äòyes‚Äô just won by a landslide.",
        "I checked destiny‚Äôs logs‚Äîstatus: ‚ÄòYES confirmed‚Äô.",
        "Today‚Äôs forecast: 100% chance of YES showers."
      ],
      tease: [
        "That ‚Äòmaybe‚Äô sounds like ‚Äòyes‚Äô wearing pajamas.",
        "Auto-correct changed ‚Äòno‚Äô ‚Üí ‚ÄòYES‚Äô. Can‚Äôt fight the system.",
        "Loading your yes‚Ä¶ 99%‚Ä¶ 100%‚Ä¶ done.",
        "Plot armor says you end up saying yes anyway."
      ],
      dramatic: [
        "In a world of maybes, be the YES.",
        "Summoning the council of feelings‚Ä¶ verdict: üíç.",
        "Cue the violins‚ÄîYES is the melody.",
        "Destiny speed-ran to ‚Äòyes‚Äô. Any objections?"
      ],
      overriders: {
        yes: ["She said YES (manifesting). Screenshot this. üéâ", "YES energy detected. Deploying heart confetti! üíó"],
        maybe: ["That‚Äôs yes in slow motion. I‚Äôll wait. üê¢üíó"],
        no: ["Error 403: ‚ÄòNo‚Äô not permitted on this domain üòå"],
        why: ["Because your smile rhymes with ‚Äòyes‚Äô. Case closed."],
      }
    };

    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }
    function weightedPick(){
      // 60% romantic, 30% tease, 10% dramatic
      const r = Math.random();
      if (r < 0.6) return pick(POOLS.romantic);
      if (r < 0.9) return pick(POOLS.tease);
      return pick(POOLS.dramatic);
    }

    function detect(text){
      const t = (text||'').toLowerCase();
      if (/(^|\b)(yes|love|marry|engage|proposal|accept)\b/.test(t)) return {type:'yes'};
      if (/(^|\b)(maybe|idk|not sure|hmm)\b/.test(t)) return {type:'maybe'};
      if (/(^|\b)(no|never)\b/.test(t)) return {type:'no'};
      if (/(^|\b)(why|reason)\b/.test(t)) return {type:'why'};
      return {type:'none'};
    }

    // Typewriter
    function typewrite(el, text, speed=32){
      el.textContent='';
      let i=0; const timer=setInterval(()=>{
        el.textContent += text.charAt(i++);
        if (i>=text.length) clearInterval(timer);
      }, speed);
    }

    // Confetti
    function confettiBurst(hearts=false){
      const box = document.getElementById('confetti');
      if(!box) return;
      const colors = hearts ? ['#ff2d55','#ff375f','#ff9f0a','#ff453a'] : ['#4285F4','#DB4437','#F4B400','#0F9D58'];
      for(let i=0;i<40;i++){
        const p = document.createElement('i');
        const x = Math.random()*100;
        const dur = 900 + Math.random()*900;
        const rot = Math.random()*360;
        p.style.left = x + 'vw';
        p.style.top = '-10px';
        p.style.opacity = '1';
        p.style.background = colors[i%colors.length];
        p.style.borderRadius = hearts ? '4px 4px 8px 8px' : '2px';
        p.animate([
          { transform:`translateY(-20px) rotate(${rot}deg)`, opacity:1 },
          { transform:`translateY(120vh) rotate(${rot+220}deg)`, opacity:0.7 }
        ], { duration: dur, easing: 'cubic-bezier(.2,.7,.2,1)'});
        box.appendChild(p);
        setTimeout(()=>box.removeChild(p), dur+60);
      }
    }

    // DOM
    const form = document.getElementById('searchForm');
    const input = document.getElementById('q');
    const dialog = document.getElementById('resultDialog');
    const chatEl = document.getElementById('chat');
    const closeModal = document.getElementById('closeModal');
    const sendBtn = document.getElementById('sendBtn');
    const chatInput = document.getElementById('chatInput');
    const statusLine = document.getElementById('statusLine');
    const testWriteBtn = document.getElementById('testWrite');

    function status(msg){ if(statusLine) statusLine.textContent = msg; console.log('[status]', msg); }

    let sessionDocId = null;
    function appendMsg(role, text, typing=false){
      const div = document.createElement('div');
      div.className = 'msg ' + (role==='user'?'me':'bot') + (typing?' thinking':'');
      div.textContent = text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
      return div;
    }

    async function botReply(userText){
      const d = detect(userText);
      let text;
      if (d.type !== 'none') {
        const pool = POOLS.overriders[d.type];
        text = Array.isArray(pool) ? pick(pool) : weightedPick();
      } else {
        text = weightedPick();
      }

      const temp = appendMsg('bot', 'Typing‚Ä¶', true);
      await new Promise(r=>setTimeout(r, 500 + Math.random()*600));
      temp.classList.remove('thinking');
      typewrite(temp, text, 26);

      if (d.type === 'yes') confettiBurst(true);

      if (window.__db?.logMessage && sessionDocId) {
        window.__db.logMessage(sessionDocId, 'bot', text);
      }
    }

    async function startChat(initialQuery){
      // Start session in Firestore (one per modal open)
      if (!sessionDocId && window.__db?.logSessionStart) {
        sessionDocId = await window.__db.logSessionStart(initialQuery);
      }

      chatEl.innerHTML = '';
      appendMsg('bot', 'Analyzing heartbeats‚Ä¶');
      await new Promise(r=>setTimeout(r, 350));
      appendMsg('bot', 'Computing destiny‚Ä¶');
      await new Promise(r=>setTimeout(r, 350));
      await botReply(initialQuery);
    }

    async function handleUserSend(){
      const text = (chatInput.value||'').trim();
      if(!text) return;
      appendMsg('user', text);
      chatInput.value = '';
      if (window.__db?.logMessage && sessionDocId) {
        window.__db.logMessage(sessionDocId, 'user', text);
      }
      await botReply(text);
    }

    function showChat(q){
      const text = (q||'').trim();
      if(!text) { input.focus(); return; }
      if (typeof dialog.showModal === 'function') dialog.showModal();
      else alert('Your browser does not support <dialog>');
      startChat(text);
      status('Chat opened');
    }

    // Search form
    form.addEventListener('submit', e => { e.preventDefault(); showChat(input.value); });
    document.getElementById('lucky').addEventListener('click', () => showChat(input.value || 'Feeling lucky'));

    // Chat events
    sendBtn.addEventListener('click', handleUserSend);
    chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter') handleUserSend(); });

    // Close
    closeModal.addEventListener('click', () => { dialog.close(); });
    dialog.addEventListener('close', () => { input.focus(); });

    // Diagnostic Firestore write
    if (testWriteBtn) {
      testWriteBtn.addEventListener('click', async () => {
        try {
          if (window.__db?.logSessionStart) {
            const id = await window.__db.logSessionStart('diagnostic test');
            if (id && window.__db?.logMessage) {
              await window.__db.logMessage(id, 'user', 'diag user');
              await window.__db.logMessage(id, 'bot', 'diag bot');
            }
            status('Diagnostic write OK');
          } else {
            status('Diagnostic: Firestore logger not available');
          }
        } catch (e) {
          status('Diagnostic write failed');
          console.error('Diagnostic write failed:', e);
        }
      });
    }
  </script>

  <script>
    window.addEventListener('error', e => console.error('Window error:', e.message));
    window.addEventListener('unhandledrejection', e => console.error('Unhandled promise rejection:', e.reason));
  </script>
</body>
</html>